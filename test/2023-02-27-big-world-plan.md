---
layout:
title:      "D项目地图应有分享"
subtitle:   ""
date:       2023-02-26
author:     "CSoap"
header-img: "img/home-bg-o.jpg"
tags:
    - 技术分享
---

- 开场白
    - 大家好，很高兴大家来到现场，首先简单介绍一下我自己。
    -我是蔡遵造，是D项目中的客户端开发，主要负责大地图模块的支持。
    - 今天，我为大家带来的分享是《D项目客户端大地图应用》，今天的主要分享将侧重大地图的逻辑向应用。
    - 首先，向大家介绍一下项目立项时候的一些情况：
    （可不讲）版本用的是：Unity2021.3版本，游戏类型类似率土likeSLG，游戏具有长视距、不需要频繁的场景加载、 等特点
    目标帧率：30FPS，游戏世界大小尺寸：目前是4k*4k的格子世界组成

- 大地图旧版本实现方案
    - 核心思想
        - 拆分为多场景sub scene
    - 实现细节
        - 拆分成多个场景，然后加载
        - 摄像机看不到的地方隐藏
        - 使用LOD
        - 实现复用（每个gird都是一个预制，所有物件都是prefab，gird都是数据，根据数据去加载不同大小缩放旋转的prefab组成）

- 分享内容大纲
    - 技术难点
    - 解决方案
    - 工作流
        - TA 通过Houdini 预先生成铺路后的整个地图表现，比提供给地图编辑器数据，具体到程序这边的数据就是一个个具体的渲染参数（待补充）
    - 常见问题
- 大地图方案要解决的核心问题
    - 场景的实时加载和卸载也是大场景游戏需要解决的一个问题
        - 玩家在大场景游戏中运动会涉及到场景的加载和卸载，因为加载量非常巨大，所以会造成一些卡顿。并且当需要加载特效或者模型时，可能会出现加载不及时的问题
        - 因为模型、贴图、地块这些都非常占内存，导致内存变大了，那么怎样去解决这些内存问题也十分关键。
        - 另外还有远景。场景大了之后，为了营造一个逼真的感观，视野必须要放得无限大，而不能把远处的山或者其它什么通过一个视距的Culling裁剪掉。这样做的话，当人物向前跑动的时候，远处的山会逐渐进入到远平面以内，这样会有一种远处的山在慢慢生长出来的错觉
        - 还有一个亟待解决的问题就是我们的运行效率。大场景意味着大的模型数量、大的面数以及很高数量的DrawCall，还有CPU的消耗，场景管理的逻辑会变得更加复杂
        - 怎么解决？
            - 场景是需要有LOD的，这对我们节省内存、节省DrawCall、提高渲染效率是非常重要的
    - 大世界的加载机制
        - 世界分块之后并非静态，而是由动态的加载机制加载到游戏里面去，它有一个很重要的因素，就是视距要无限远，这样才能有一个一望无际的真实体验。在这样的情况下，我们怎样去设计它的加载机制？我们要加载不同的LOD，因为可以节省内存。在远处的地方，加载最差一级的LOD，在较近的地方加载精度稍微低一点的地形块，在最近的地方加载全精度的。
        然后我们并没有使用World Composition引擎自带的加载逻辑，而是实现了一整套全Lua加载逻辑。
    - 阴影
        - 较远处小物体、部分低精度LOD不投射阴影、或者投射阴影但是使用假面片挂在物体脚底
    - 卡顿
        - 主线程IO，虽然Unity在主线程里都给了异步加载接口，实际上还是有IO存在的，因为Unity下资源的初始化被分为了两部分，加载是一部分，但是创建是同步的，一个是我们在调用Object的instance，另一个是它第一次可见也就是第一次tick的时候,分别在这两个部分产生IO
    - 同一帧内大量创建和销毁对象
    - 内存
    - 渲染压力
    - 发热、功耗
    - 资源热更和打包

- 资源
    - 

- 优化
    - 万物皆可LOD，网格、贴图、甚至AI
    - 合批（太多可说的了）
    - 不加载 ：不连通的地方 远的地方 看不见的地方； 低端机不加载特效和灯光(需要拆分场景)
    - 预加载 ：一些即将要使用的预制、固定出现物都可以预先在进入场景时加载或者一些时机加载
    - 惰性加载 ：需要才用到才加载 例如怪物的动画 一些小的表格
    - 同步加载  ：logic部分
    - 异步加载 ： 基本全部异步....渲染网格和机关、特效(逻辑渲染分离)、怪物、NPC
    - 分帧加载/删除 ： 怪物、NPC、网格渲染和机关（队列）、渲染部分也被拆分分帧加载
    - 拆分加载 ： 如果场景已经制作好，可以制作工具拆分场景，拆分后配合分帧，获得更顺畅的加载
    - 分帧LoadAsset ：底层异步loadAsset分帧了
    - 使用池  ： 怪物、特效、子弹等，复用就不用加载
    - 实例化卡顿 ：Unity的实例化无法异步，2019的新版可以异步实例化，比较好的方法是先加载低模，然后再到高模
卡顿优化（太多可说的了）
    - 内存过大 ：如果加载了保持引用，除了切换场景，不会释放ab和asset，导致玩久了内存高  调用ab的unload(true)，当asset没有引用时，适当时机调用res的unloadunuse

- 思考一个问题
    - 一个处于aoi之外的部队走入aoi，这个是服务端主动推送吗
    - 寻路
        - 按块切割后只导航加载的块，全图导航放服务器,如果有可改变地形,把地形修改信息也一同发往服务器
    - 跟盘琪确认一下lod用什么工具做

- 总结
    - 美术资源把控
        - 问题
            - 目前项目组内是 默认各司其职，美术资源由美术提交，策划提交相关配置表等。由于性能测试每周都会进行跑测，有一周发现突然游戏某几帧画面三角面片暴涨很多倍，后面才定位到是策划提交了某个临时prefab，面数有十几万，后面才了解是相关美术职能本周不能输出对应资源，策划自己找个资源上传，对于策划同学可能不会关注这些，但是这种问题的出现会导致两周性能对比跑测数据就会有差异。
        - 怎么解决？
            - 可以写好相关检测常见资源脚本，如预制体的mesh面数、顶点数检测、贴图大小检测等，
            - svn提交之后直接执行脚本测试，然后接入钉钉hook，如果不符合规范直接打回，并告知为何失败，这样就可以从根本上解决资源不可把控的情况。
    - 资源把控
        - 地图分片上涨，是否做到了资源可控，如无限制跳转行为导致分片内存上涨，怎么解决
        - 地图分片ab 拆分，粒度、数量如何把控